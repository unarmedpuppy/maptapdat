<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPTAPDAT // Daily Geography Scores</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap');

        :root {
            --green: #00ff41;
            --dim-green: #00aa2a;
            --dark-green: #003b00;
            --amber: #ffb000;
            --red: #ff0040;
            --cyan: #00ffff;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --bg: #0a0a0a;
            --panel-bg: #0d1117;
            --border: #1a3a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--green);
            font-family: 'Share Tech Mono', 'Courier New', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* CRT scan line effect */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 1000;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            92% { opacity: 1; }
            93% { opacity: 0.8; }
            94% { opacity: 1; }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            animation: flicker 4s infinite;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .header h1 {
            font-family: 'VT323', monospace;
            font-size: 2.5rem;
            letter-spacing: 6px;
            text-shadow: 0 0 10px var(--green), 0 0 20px var(--green);
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: var(--dim-green);
            font-size: 0.85rem;
            letter-spacing: 2px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Panels */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .panel-header {
            background: linear-gradient(90deg, var(--dark-green), transparent);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 0.9rem;
            letter-spacing: 2px;
            color: var(--green);
        }

        .panel-body { padding: 15px; }

        /* Today's Winner */
        .winner-panel {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .winner-panel .panel-header {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), transparent);
        }

        .winner-display {
            text-align: center;
            padding: 10px;
        }

        .winner-name {
            font-family: 'VT323', monospace;
            font-size: 2rem;
            color: var(--gold);
            text-shadow: 0 0 10px var(--gold);
            text-transform: capitalize;
        }

        .winner-score {
            font-family: 'VT323', monospace;
            font-size: 3rem;
            color: var(--green);
            text-shadow: 0 0 15px var(--green);
            margin: 5px 0;
        }

        .winner-date {
            font-size: 0.8rem;
            color: var(--dim-green);
        }

        /* Leaderboard Table */
        .leaderboard-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--dark-green);
            color: var(--green);
            font-weight: normal;
            letter-spacing: 1px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(0, 255, 65, 0.05);
        }

        .rank-1 { color: var(--gold); }
        .rank-2 { color: var(--silver); }
        .rank-3 { color: var(--bronze); }

        .rank-cell {
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            min-width: 40px;
        }

        .player-name {
            color: var(--cyan);
            text-transform: capitalize;
            font-weight: bold;
        }

        .score-cell {
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
        }

        /* All-Time High Scores */
        .high-scores-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .high-score-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border-left: 3px solid;
        }

        .high-score-item.gold { border-color: var(--gold); }
        .high-score-item.silver { border-color: var(--silver); }
        .high-score-item.bronze { border-color: var(--bronze); }

        .hs-rank {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            min-width: 30px;
        }

        .gold .hs-rank { color: var(--gold); }
        .silver .hs-rank { color: var(--silver); }
        .bronze .hs-rank { color: var(--bronze); }

        .hs-info {
            flex: 1;
        }

        .hs-player {
            color: var(--cyan);
            font-weight: bold;
            text-transform: capitalize;
        }

        .hs-date {
            font-size: 0.75rem;
            color: var(--dim-green);
        }

        .hs-score {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
        }

        .gold .hs-score { color: var(--gold); text-shadow: 0 0 8px var(--gold); }
        .silver .hs-score { color: var(--silver); }
        .bronze .hs-score { color: var(--bronze); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .stat {
            text-align: center;
            padding: 12px 8px;
            background: rgba(0, 255, 65, 0.03);
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .stat-value {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            color: var(--green);
            text-shadow: 0 0 5px var(--green);
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--dim-green);
            letter-spacing: 1px;
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--dim-green);
            font-size: 0.75rem;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }

        .footer a {
            color: var(--cyan);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--dim-green);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .loading-text {
            animation: blink 1s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; letter-spacing: 4px; }
            .header .subtitle { font-size: 0.75rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            table { font-size: 0.75rem; }
            th, td { padding: 8px 5px; }
            .winner-name { font-size: 1.5rem; }
            .winner-score { font-size: 2.5rem; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.6rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .stat { padding: 10px 6px; }
            .stat-value { font-size: 1.3rem; }
            .stat-label { font-size: 0.6rem; }
            th, td { padding: 6px 4px; font-size: 0.7rem; }
            .rank-cell { font-size: 1rem; }
            .score-cell { font-size: 0.95rem; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--dark-green); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>MAPTAPDAT</h1>
            <div class="subtitle">tappin' maps & trackin' stats with the homies</div>
        </header>

        <!-- Today's Winner -->
        <div class="panel winner-panel">
            <div class="panel-header">
                <span class="panel-title">[ üèÜ TODAY'S WINNER ]</span>
                <span id="winner-date-label" style="color: var(--dim-green); font-size: 0.8rem;"></span>
            </div>
            <div class="panel-body">
                <div class="winner-display" id="todays-winner">
                    <div class="loading-text">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">[ üìä LEADERBOARD ]</span>
            </div>
            <div class="panel-body" style="padding: 0;">
                <div class="leaderboard-table">
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Player</th>
                                <th>Total</th>
                                <th>Avg</th>
                                <th>Games</th>
                                <th>Perfect</th>
                                <th>Low</th>
                                <th>Streak</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr><td colspan="8" class="loading-text" style="text-align: center; padding: 20px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All-Time High Scores -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">[ üëë ALL-TIME HIGH SCORES ]</span>
            </div>
            <div class="panel-body">
                <div class="high-scores-list" id="high-scores-list">
                    <div class="loading-text" style="text-align: center;">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">[ üìà STATS ]</span>
            </div>
            <div class="panel-body">
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value" id="stat-total-games">-</div>
                        <div class="stat-label">Total Games</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-total-players">-</div>
                        <div class="stat-label">Players</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-perfect-scores">-</div>
                        <div class="stat-label">Perfect 100s</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-avg-score">-</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            MAPTAPDAT // <a href="https://maptap.gg" target="_blank">maptap.gg</a> //
            <a href="/api/data" download="maptapdat.csv" id="export-csv">Export CSV</a>
        </footer>
    </div>

    <script>
        async function loadData() {
            try {
                const [dataRes, leaderboardRes, analyticsRes] = await Promise.all([
                    fetch('/api/data'),
                    fetch('/api/leaderboard'),
                    fetch('/api/analytics')
                ]);

                const data = await dataRes.json();
                const leaderboard = await leaderboardRes.json();
                const analytics = await analyticsRes.json();

                renderTodaysWinner(data);
                renderLeaderboard(leaderboard);
                renderHighScores(data);
                renderStats(analytics, leaderboard);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function renderTodaysWinner(data) {
            // Group by date to find most recent
            const byDate = {};
            data.forEach(g => {
                if (!byDate[g.date]) byDate[g.date] = {};
                const key = g.user.toLowerCase();
                if (!byDate[g.date][key]) {
                    byDate[g.date][key] = { user: g.user, score: g.total_score };
                }
            });

            const dates = Object.keys(byDate).sort().reverse();
            const mostRecentDate = dates[0];

            if (!mostRecentDate) {
                document.getElementById('todays-winner').innerHTML = '<div style="color: var(--dim-green);">No data yet</div>';
                return;
            }

            const players = Object.values(byDate[mostRecentDate]);
            const winner = players.reduce((a, b) => a.score > b.score ? a : b);

            const dateObj = new Date(mostRecentDate + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            document.getElementById('winner-date-label').textContent = formattedDate;
            document.getElementById('todays-winner').innerHTML = `
                <div class="winner-name">${winner.user}</div>
                <div class="winner-score">${winner.score}</div>
                <div class="winner-date">${players.length} player${players.length !== 1 ? 's' : ''} competed</div>
            `;
        }

        function renderLeaderboard(leaderboard) {
            const tbody = document.getElementById('leaderboard-body');

            if (!leaderboard || leaderboard.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--dim-green);">No data</td></tr>';
                return;
            }

            // Sort by average score descending
            leaderboard.sort((a, b) => b.avgScore - a.avgScore);

            tbody.innerHTML = leaderboard.map((player, idx) => {
                const rank = idx + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const rankDisplay = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;

                return `
                    <tr>
                        <td class="rank-cell ${rankClass}">${rankDisplay}</td>
                        <td class="player-name">${player.user}</td>
                        <td class="score-cell">${player.totalScore.toLocaleString()}</td>
                        <td class="score-cell">${player.avgScore.toFixed(0)}</td>
                        <td>${player.gamesPlayed}</td>
                        <td>${player.perfectScores || 0}</td>
                        <td>${player.lowestScore || '-'}</td>
                        <td>${player.currentStreak || 0}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderHighScores(data) {
            // Group by user-date to get unique games
            const games = {};
            data.forEach(g => {
                const key = `${g.user.toLowerCase()}-${g.date}`;
                if (!games[key]) {
                    games[key] = { user: g.user, date: g.date, score: g.total_score };
                }
            });

            // Sort by score and get top 3
            const top3 = Object.values(games)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);

            const container = document.getElementById('high-scores-list');

            if (top3.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--dim-green);">No data</div>';
                return;
            }

            const medals = ['gold', 'silver', 'bronze'];
            const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];

            container.innerHTML = top3.map((entry, idx) => {
                const dateObj = new Date(entry.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return `
                    <div class="high-score-item ${medals[idx]}">
                        <div class="hs-rank">${rankEmojis[idx]}</div>
                        <div class="hs-info">
                            <div class="hs-player">${entry.user}</div>
                            <div class="hs-date">${formattedDate}</div>
                        </div>
                        <div class="hs-score">${entry.score}</div>
                    </div>
                `;
            }).join('');
        }

        function renderStats(analytics, leaderboard) {
            document.getElementById('stat-total-games').textContent = analytics.totalGames || 0;
            document.getElementById('stat-total-players').textContent = analytics.uniquePlayers || 0;

            // Count perfect 100 location scores
            const perfectCount = analytics.perfectScoreLeaders?.reduce((sum, p) => sum + (p.perfectScores || 0), 0) || 0;
            document.getElementById('stat-perfect-scores').textContent = perfectCount;

            // Calculate overall average
            if (leaderboard && leaderboard.length > 0) {
                const totalScores = leaderboard.reduce((sum, p) => sum + p.totalScore, 0);
                const totalGames = leaderboard.reduce((sum, p) => sum + p.gamesPlayed, 0);
                const avgScore = totalGames > 0 ? Math.round(totalScores / totalGames) : 0;
                document.getElementById('stat-avg-score').textContent = avgScore;
            }
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
